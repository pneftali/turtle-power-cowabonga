<?phpclass MessageController extends Zend_Controller_Action{    protected $_instance;    protected $_json;        public function init()    {           date_default_timezone_set('Asia/Seoul');                $this->_instance = Zend_Auth::getInstance();        if(!$this->_instance->hasIdentity())            $this->_helper->redirector('index','login');         $this->_json = array('m' => '');                            }    public function indexAction()    {    }/*---------------------------    Request is coming from ajax - home.js      What this controller does is two-fold:        1. If email is not registered, the message will be sent to the email address.        2. If email is registered, send the message w/in WNF and update.  ----------------------------*/    public function postAction()    {        $_SESSION['count']  -= 1;      	$this->disableLayout();        $baseURL            = 'http://'.$_SERVER['HTTP_HOST'];        $identityObject     = $this->_instance->getIdentity();        $post               = $this->getRequest()->getPost();        $employeeModel      = new Application_Model_DbTable_Employee();        $userEmail          = $employeeModel->checkIfUserExistsBy($post['email']);        $count              = $userEmail['count'];                             if($_SESSION['count'] < 0){            $this->_json['m'] = 'no more cards';            echo json_encode($this->_json);        } else {                    if(!$count){                                // 1) Insert msg first to private table                $privateModel   = new Application_Model_DbTable_Private();                $data = array(                    'email'                 => $post['email'],                    'message'               => $post['message'],                    'confirmation_link'     => hash('md5', $post['email']),                    'employee_code_from'    => $identityObject->employee_code,                    'hide'                  => $post['hide']                );                $messageID = $privateModel->postMessage($data);                // 2) Send email                $hash   = hash('md5', $post['email']);                /*                if($post['hide']){                    $body   = "                        <div style='margin-bottom: 10px'>                            Good day!                         </div>                        <div style='margin-bottom: 10px'>                            Someone has sent you a Thx message.                        </div>                        <div>                                                Click here to view the message                            <a href='".$baseURL."/message/".$hash."/".$messageID."'>                            ".$baseURL."/invite/".$hash."/".$messageID."                        </div>                    ";                } else{                    $body   = "                        <div style='margin-bottom: 10px'>                            Good day!                         </div>                        <div style='margin-bottom: 10px'>                            ".$identityObject->full_name." has sent you a Thx message.                        </div>                        <div>                                                Click here to view the message                            <a href='".$baseURL."/message/".$hash."/".$messageID."'>                            ".$baseURL."/invite/".$hash."/".$messageID."                        </div>                    ";                }                */                $body   =   "   <table width='510px' cellpadding='0' cellspacing='0'>";                $body   .=  "       <tr>";                $body   .=  "           <td style='padding: 10px 15px; background:#FAFECB;'>";                $body   .=  "                <span style='color:#D5006A; font-size:25px'>Hello :)</span>";                $body   .=  "           </td>";                $body   .=  "       <tr>";                $body   .=  "       <tr>";                $body   .=  "           <td style='padding: 10px 15px; background:#EEE;'>";                if($post['hide']){                    $body   .= "        Someone at GE has sent you a Card on <span style='color:#D5006A;'>ThxBox!</span>";                } else{                    $body   .= "        <span style='color:#D5006A; font-size: 20px;'>".$identityObject->full_name."</span> has sent you a Card on <span style='color:#D5006A;'>ThxBox!</span>";                }                    $body   .=  "           </td>";                $body   .=  "       <tr>";                $body   .=  "   </table>";                $body   .=  "   <table width='510px' cellpadding='0' cellspacing='0'>";                $body   .=  "       <tr>";                $body   .=  "           <td style='padding: 10px 10px 10px 15px; background:#EEE; width: 105px'>";                if($post['hide']){                    $body   .=  "           <img src='".$baseURL."/images/profile/default.png' />";                } else{                    $body   .=  "           <img src='".$baseURL.$identityObject->profile_img_path."' />";                }                 $body   .=  "           </td>";                $body   .=  "           <td style='padding: 10px 10px 10px 0; background:#EEE; width: 30px'>";                $body   .=  "                <img src='".$baseURL."/images/email/double_arrow_right.png' />";                $body   .=  "           </td>";                $body   .=  "           <td style='padding: 10px 10px 10px 0; background:#EEE;'>";                $body   .=  "                <a style='color: #D5006A; text-decoration: none;' href='".$baseURL."/message/".$hash."/".$messageID."' >";                $body   .=  "                   <img src='".$baseURL."/images/email/click_to_sign_btn.png' />";                $body   .=  "                </a>";                $body   .=  "           </td>";                $body   .=  "       <tr>";                $body   .=  "   </table>";                $body   .=  "   <table width='510px' cellpadding='0' cellspacing='0'>";                $body   .=  "       <tr>";                $body   .=  "           <td style='padding: 5px 5px 10px 15px; background:#EEE;'>";                $body   .=  "                <span style='color:#000; font-size: 11px;'>Please do not reply to this system generated email.</span>";                $body   .=  "           </td>";                $body   .=  "       <tr>";                $body   .=  "   </table>";                                $this->sendEmail($post['email'], $body, $identityObject, $post['hide']);                             // 3) Update (or insert if no data exists) count table                                  $countModel     = new Application_Model_DbTable_Count();                $ret            = $countModel->updateCount($identityObject);                                    $this->_json['m'] = 'new user';                echo json_encode($this->_json);                             } else{                                // We should check first if                 // 1) Insert to message table                if($post){                	$messageModel 	= new Application_Model_DbTable_Message();                	$ret 			= $messageModel->postMessage($post, $identityObject);                }                                 // 2) Update rankings table                if($ret){                	$rankingsModel 	= new Application_Model_DbTable_Rankings();                	$ret 			= $rankingsModel->updateStatus($post['code_to'], $identityObject);                }                      // 3) Update (or insert if no data exists) count table                      if($ret){                    $countModel     = new Application_Model_DbTable_Count();                    $ret            = $countModel->updateCount($identityObject);                }                                      // 4) Send to Email                $link       = explode('@', $identityObject->email);                $link_to    = explode('@', $post['email']);                $baseURL    = 'http://'.$_SERVER['HTTP_HOST'];                              $body   =   "   <table width='510px' cellpadding='0' cellspacing='0'>";                $body   .=  "       <tr>";                $body   .=  "           <td style='padding: 10px 15px; background:#FAFECB;'>";                $body   .=  "                <span style='color:#D5006A; font-size:25px'>Hello ".$post['name_to']."!</span>";                $body   .=  "           </td>";                $body   .=  "       <tr>";                $body   .=  "       <tr>";                $body   .=  "           <td style='padding: 10px 15px; background:#EEE;'>";                if($post['hide']){                    $body   .= "        Someone at GE has sent you a Card on <span style='color:#D5006A;'>ThxBox!</span>";                } else{                    $body   .= "        <span style='color:#D5006A; font-size: 20px;'>".$identityObject->full_name."</span> has sent you a Card on <span style='color:#D5006A;'>ThxBox!</span>";                }                    $body   .=  "           </td>";                $body   .=  "       <tr>";                $body   .=  "   </table>";                $body   .=  "   <table width='510px' cellpadding='0' cellspacing='0'>";                $body   .=  "       <tr>";                $body   .=  "           <td style='padding: 10px 10px 10px 15px; background:#EEE; width: 105px'>";                if($post['hide']){                    $body   .=  "                <img src='".$baseURL."/images/profile/default.png' />";                } else{                    $body   .=  "                <img src='".$baseURL.$identityObject->profile_img_path."' />";                }                                                 $body   .=  "           </td>";                $body   .=  "           <td style='padding: 10px 10px 10px 0; background:#EEE; width: 30px'>";                $body   .=  "                <img src='".$baseURL."/images/email/double_arrow_right.png' />";                $body   .=  "           </td>";                $body   .=  "           <td style='padding: 10px 10px 10px 0; background:#EEE;'>";                $body   .=  "                <a style='color: #D5006A; text-decoration: none;' href='".$baseURL."/user/".$link_to[0]."' >";                $body   .=  "                   <img src='".$baseURL."/images/email/click_to_view_btn.png' />";                $body   .=  "                </a>";                $body   .=  "           </td>";                $body   .=  "       <tr>";                $body   .=  "   </table>";                $body   .=  "   <table width='510px' cellpadding='0' cellspacing='0'>";                $body   .=  "       <tr>";                $body   .=  "           <td style='padding: 5px 5px 0 15px; background:#EEE; width:20px;'>";                $body   .=  "                <img src='".$baseURL."/images/email/hand_small.png' />";                $body   .=  "           </td>";                $body   .=  "           <td style='padding: 5px 5x 0 0; background:#EEE;'>";                $body   .=  "                <a style='color: #D5006A; text-decoration: none;' href='".$baseURL."/user/".$link_to[0]."' >".$baseURL."/user/".$link_to[0]."</a>";                $body   .=  "           </td>";                $body   .=  "       <tr>";                $body   .=  "   </table>";                $body   .=  "   <table width='510px' cellpadding='0' cellspacing='0'>";                $body   .=  "       <tr>";                $body   .=  "           <td style='padding: 5px 5px 10px 15px; background:#EEE;'>";                $body   .=  "                <span style='color:#000; font-size: 11px;'>Please do not reply to this system generated email.</span>";                $body   .=  "           </td>";                $body   .=  "       <tr>";                $body   .=  "   </table>";                /*                $body   .=  "   <table width='510px' cellpadding='0' cellspacing='0'>";                $body   .=  "       <tr>";                $body   .=  "           <td style='padding: 10px 10px 10px 15px; background:#99FFFE; width: 275px'>";                $body   .=  "                <span>Click the Feedback button in ThxBox if you have any comments or questions.</span>";                $body   .=  "           </td>";                $body   .=  "           <td style='padding: 10px 10px 10px 0; background:#99FFFE;'>";                $body   .=  "                <img src='".$baseURL."/images/email/hand_big.png' />";                $body   .=  "           </td>";                $body   .=  "       <tr>";                $body   .=  "   </table>";                */                $this->sendEmail($post['email'], $body, $identityObject, $post['hide']);                                 $this->_json['m'] = 'old user';                echo json_encode($this->_json);            }        }    }  /*---------------------------    Get the top 5 recent cards.  ----------------------------*/        public function getTopRecentCardsAction()    {        $this->disableLayout();        $identityObject = $this->_instance->getIdentity();        $messageModel   = new Application_Model_DbTable_Message();        $where = array(            $identityObject->employee_code,            date('n'),            date('Y')            );        $ret = $messageModel->fetchRecentTopFiveSentCards($where);        echo json_encode($ret);    }/*---------------------------    Get All cards.  ----------------------------*/        public function getAllCardsAction()    {        $this->disableLayout();        $identityObject = $this->_instance->getIdentity();        $messageModel   = new Application_Model_DbTable_Message();        $where = array(            $identityObject->employee_code,            date('n'),            date('Y')            );        $ret = $messageModel->fetchAllSentMessage($where);        echo json_encode($ret);    }    /*  --------------------------------------------------    Helper Functions    -------------------------------------------------- */        private function disableLayout()    {        $front = Zend_Controller_Front::getInstance();        $front->setParam('noViewRenderer',true);        $this->_helper->layout()->disableLayout();    }            private function sendEmail($email, $body, $user, $visible)    {        $config = array(                'port'  => 587,                'ssl'   => 'tls',                'auth' => 'login',                'username' => 'n.papelleras@arcanys.com',                'password' => '1qaz45');        $tr = new Zend_Mail_Transport_Smtp('mail.arcanys.com', $config);                Zend_Mail::setDefaultTransport($tr);        $mail = new Zend_Mail();        $mail->setBodyHtml($body);        $mail->setFrom('no-reply@thxbox.com', 'ThxBox Notification');        $mail->addTo($email);        if($visible){            $mail->setSubject('Someone has sent you a card on ThxBox!');        } else {            $mail->setSubject($user->full_name.' has sent you a card on ThxBox!');        }        try {            $sent = $mail->send($tr);        } catch (Zend_Mail_Exception $e) {            die($e);        }            }    }